<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seller - LocalShop</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="./" class="text-sky-700">← Back</a>
      <h1 id="sellerName" class="text-lg font-extrabold tracking-tight text-sky-600">Seller</h1>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 pt-4">
    <div id="sellerInfo" class="mb-3 text-sm text-slate-600"></div>
    <h2 class="text-sm font-semibold text-slate-700 mb-2">Listings</h2>

    <div id="listings" class="grid gap-3"></div>
    <div id="loading" class="text-center text-sm text-slate-500 py-4 hidden">Loading…</div>
    <div id="end" class="text-center text-sm text-slate-400 py-4 hidden">End of results</div>
  </main>

  <template id="cardTpl">
    <a class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm block">
      <div class="aspect-video bg-slate-100 overflow-hidden relative">
        <img class="w-full h-full object-cover" loading="lazy" />
      </div>
      <div class="p-3">
        <div class="font-medium truncate"></div>
        <div class="text-sky-700 font-semibold"></div>
        <div class="text-xs text-slate-500"></div>
      </div>
    </a>
  </template>

  <script type="module">
    const API_BASE = (window.API_BASE || 'http://localhost:4000');

    const listingsEl = document.getElementById('listings');
    const loadingEl = document.getElementById('loading');
    const endEl = document.getElementById('end');
    const sellerNameEl = document.getElementById('sellerName');
    const sellerInfoEl = document.getElementById('sellerInfo');

    let cursor = null;
    let fetching = false;
    let done = false;

    function php(n) { return `₱${Number(n).toLocaleString('en-PH')}`; }
    function qs(params) { return new URLSearchParams(params).toString(); }
    function cld(url, transform = 'f_auto,q_auto,c_fill,w_600,h_400') {
      if (!url) return url;
      const marker = '/upload/';
      const idx = url.indexOf(marker);
      if (idx === -1) return url;
      return url.slice(0, idx + marker.length) + transform + '/' + url.slice(idx + marker.length);
    }

    const params = new URLSearchParams(location.search);
    const name = params.get('name') || '';
    const phone = params.get('phone') || '';
    if (name) sellerNameEl.textContent = name;
    sellerInfoEl.textContent = phone ? `Contact: ${phone}` : '';

    async function fetchListings(reset=false) {
      if (fetching || done) return;
      fetching = true;
      loadingEl.classList.remove('hidden');
      if (reset) {
        listingsEl.innerHTML = '';
        cursor = null;
        done = false;
        endEl.classList.add('hidden');
      }

      const qParams = {
        sellerName: name || '',
        sellerPhone: phone || '',
        cursor: cursor || '',
        limit: 12,
      };

      const res = await fetch(`${API_BASE}/api/listings?${qs(qParams)}`);
      const data = await res.json();

      (data.items || []).forEach(renderCard);

      cursor = data.nextCursor || null;
      if (!cursor || (data.items || []).length === 0) {
        done = true;
        endEl.classList.remove('hidden');
      }

      loadingEl.classList.add('hidden');
      fetching = false;
    }

    function renderCard(item) {
      const tpl = document.getElementById('cardTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      const img = node.querySelector('img');
      const title = node.querySelector('.font-medium');
      const price = node.querySelector('.font-semibold');
      const meta = node.querySelector('.text-xs');

      const raw = (item.images && item.images[0] && item.images[0].url) || '';
      img.src = cld(raw) || 'https://placehold.co/600x400?text=No+Image';
      title.textContent = item.title;
      price.textContent = php(item.price);
      meta.textContent = [item.location?.city, item.location?.region].filter(Boolean).join(', ');
      node.href = `./item.html?id=${item._id}`;

      listingsEl.appendChild(node);
    }

    window.addEventListener('scroll', () => {
      const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 300;
      if (nearBottom) fetchListings();
    });

    fetchListings(true);
  </script>
</body>
</html>
